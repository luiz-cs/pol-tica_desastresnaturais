---
title: "Código - Análise de experimento natural: efeito de desastres naturais na agenda política climática municipal no Brasil"
output: html_notebook
---

# 0. Bibliotecas

```{r, echo=FALSE}
library(tidyverse)
library(readxl)
library(here)
library(RColorBrewer)
library(stringi)
library(performance)
library(plm)
library(geobr)
library(sf)
library(lubridate)
library(stargazer)

firstup = function(x){
    stri_trans_general(paste(toupper(substring(x, 1, 1)),
          tolower(substring(x, 2, nchar(x))),
          sep = ""), "latin-ascii") }
```

# 1. Recolhendo os dados

## 1.1 Dados sobre desastres:

```{r, warning=FALSE, 'Baixando_desastres'}
# Fonte Dados BD Atlas: http://atlasdigital.mdr.gov.br/paginas/downloads.xhtml

Desastres <- read_excel(path = here("Dados/BD_Atlas_1991_2022.xlsx"), sheet = "Atlas - Valores Corrigidos")
```

```{r, 'Limpando_desastres'}

Desastres <- Desastres  %>% 
  select(ibge,municipio,uf,regiao,data,tipologia, descricao_tipologia, grupo_de_desastre, obitos, total_danos_humanos,prejuizos_totais) %>% 
  rename("Município" = "municipio", 
         "UF" = "uf",
         "Desastre" = "descricao_tipologia",
         "Grupo_Desastre" = "grupo_de_desastre",
         "Data" = "data") %>% 
  mutate(Data = as.Date(Data)) %>% 
    mutate("Mês" = month(`Data`), 
           "Ano" = year(`Data`), 
           Município = firstup(stri_trans_general(Município, "latin-ascii"))) %>% 
   filter(!(Desastre %in% c('Doenças infecciosas','Rompimento/Colapso de barragens', 'Outros')))

saveRDS(Desastres, file = here("Dados/Desastres.RDS"))
```

## 1.2 Dados de atividade legislativa

```{r, 'Baixando os dados atividade legislativa'}
#Dados retirados da api dos municípios. Link "https://sapl.nomedacidade.uf.leg.br/api/materia/materialegislativa
#Código para levantar e compilar todos em anexo (em Python)
CidadesAL <- read_csv(file= here("Dados/ProjCidades.csv"))
```

```{r, 'Adicionando_UF'}
CidadesAL <- CidadesAL %>% 
  mutate(UF = substring(gsub(".*\\.([^.]+)\\.[^.]+\\..*", "\\1", API_URL), 1, 2)) %>%
  group_by(City) %>%
  mutate(prim.ano = min(ano),
         Município = firstup(stri_trans_general(City, "latin-ascii")),
         UF = toupper(UF),
         data_apresentacao = as.Date(data_apresentacao),
         Tipo_Projeto = firstup(sub(" nº.*", "", `__str__`))) %>% 
  rename("Nome Propositura" = "__str__",
         "Data" = "data_apresentacao",
         "Ano" = "ano")
```

```{r, 'Selecionando_dados_AL'}

CidadesAL <- readRDS(file = here("Dados/CidadesAL.RDS")) %>% 
  select(!(c(metadata, tipo_apresentacao, ip, user, anexadas,autores))) %>% 
  filter(Ano >= 1991) %>% 
  ungroup()

mCidadesAl <- CidadesAL %>% 
  select(c(Data, Tipo_Projeto, ementa, Município, UF, prim.ano))%>% 
  mutate(Mês = month(Data),
         Ano = year(Data),
         Tipo_Projeto = firstup(Tipo_Projeto),
         Tipo = stri_trans_general(sub(" .*", "", `Tipo_Projeto`), "latin-ascii")) %>% 
  filter(Ano >= 1991,
         Ano <= 2022)%>% 
  mutate(ementa = tolower(sub("\\*.*?\\*", "", ementa)))
```

```{r, 'termos_clima'}

termos_clima <- c(" clima", " adaptação climática", " defesa civil", " alagamento", " inundação", " deslizamento", " aquecimento global", " mitigação", " fortes chuvas"," ventos", " deslizamentos", " soterramentos", " inundações", " desabamentos", " incêndios", " enxurradas", " alagamentos", " eventos climáticos extremos", " chuvas")
  
# Create an empty column to store the found climate terms
mCidadesAl$clima_termos <- NA_character_

# Create an empty column to store whether climate terms were found
mCidadesAl$projetoclima <- FALSE

# Iterate over each term in the list
for (termo in termos_clima) {
  # Check if the term appears in each value of the "ementa" column
  termo_found <- grepl(termo, mCidadesAl$ementa, ignore.case = TRUE)
  
  # Update the "clima_termos" column with the found terms
  mCidadesAl$clima_termos[termo_found] <- ifelse(is.na(mCidadesAl$clima_termos[termo_found]), termo, paste(mCidadesAl$clima_termos[termo_found], termo, sep = ", "))
  
  # Update the "projetoclima" column
  mCidadesAl$projetoclima <- mCidadesAl$projetoclima | termo_found
}

ALClima <- mCidadesAl %>% 
  filter(projetoclima == T)


saveRDS(ALClima, file = here("Dados/ALClima.RDS"))
saveRDS(mCidadesAl, file = here("Dados/mCidadesAL.RDS"))

rm(CidadesAL, ALClima)
```

## 1.3 Dados municipais

```{r, 'Baixar_dados_munic'}
#Dados Censo 2022: https://www.ibge.gov.br/estatisticas/sociais/populacao/22827-censo-demografico-2022.html?=&t=downloads

Censo2022 <- read_excel(path = here("Dados/CD2022_Populacao_Coletada_Imputada_e_Total_Municipio_e_UF_20231222.xlsx"), skip = 2)

#Dados MapBiomas: https://brasil.mapbiomas.org/estatisticas/
MapBiomas <- read_excel(path = here("Dados/tabela_geral_mapbiomas_col8_biomas_municipios.xlsx"), sheet = "COBERTURA_COL8.0")

#Municípios Costeiros: https://www.ibge.gov.br/geociencias/organizacao-do-territorio/estrutura-territorial/34330-municipios-costeiros.html
Costeiro <- read_excel(path = here("Dados/Municipios_Costeiros_2021.xls"))

#IDH-M Brasil: http://idhm.org.br/ranking
IDHM2010 <- read_excel(path = here("Dados/IDHM_data.xlsx"))

```

```{r, 'Limpar_dados_munic'}
#Dados Censo
Censo2022 <- Censo2022 %>% 
  rename("Município" = "NOME DO MUNICÍPIO",
         "Populacao_2022" = "POP. TOTAL")%>% 
  mutate(Município = firstup(stri_trans_general(Município, "latin-ascii")),
         ibge = paste0(`COD. UF`, `COD. MUNIC`)) %>% 
    select(!(c(`POP. COLETADA`,`POP. IMPUTADA`, `COD. UF`, `COD. MUNIC`))) 


#Dados Bioma
MapBiomas <- MapBiomas %>% 
  select(!(c(feature_id, `biome [municipality]`, color, level_1, level_2,level_3, category,`1985`, `1986`, `1987`, `1988`, `1989`, `1990`)))%>% 
  pivot_longer(cols = c(`1991`:`2022`), names_to = "Ano", values_to = "area_cobertura")%>%
  rename("Bioma" = "biome",
         "Município" = "municipality",
         "UF" = "state_acronym",
         "ibge" = "geocode")%>% 
  pivot_wider(names_from = c(level_0, level_4), values_from = area_cobertura)%>% 
  mutate(Município = firstup(stri_trans_general(Município, "latin-ascii")))


#MapBiomas <- MapBiomas %>% 
  #group_by(Bioma,Município, UF, ibge, class_id, Ano) %>% 
  #summarise(across(everything(), ~ if(all(is.na(.))) NA else na.omit(.)[1]))


#Bioma reduzido
mMapBiomas <- MapBiomas %>% 
  select(Bioma, Município, UF, ibge, Ano) %>% 
  distinct(ibge, Município, UF, Ano, .keep_all = TRUE) %>% #remove casos em que há dois biomas no mesmo município e ano
  mutate(ibge = as.character(ibge)) 
#Costeiro

Costeiro <- Costeiro %>% 
  select(CD_MUN, NM_MUN) %>% 
  rename("ibge" = CD_MUN,
         "Município" = NM_MUN) %>%
  mutate("Costeiro" = 1, 
         "Município" = firstup(Município))

#IDH
IDHM2010 <- IDHM2010 %>% 
  select(Territorialidade, IDHM_2010) %>% 
  mutate(UF = str_extract(Territorialidade, "\\((.*?)\\)"),
         Territorialidade = stri_trans_general(sub(" \\(.*", "", `Territorialidade`), "latin-ascii")) %>%
  mutate(Territorialidade = firstup(stri_trans_general(Territorialidade, "latin-ascii")),
        UF = gsub("\\(|\\)", "", UF)) %>% 
  rename("Município" = Territorialidade,
         "IDHM_2010" = IDHM)
```

```{r, 'Juntando_dados_munic'}

Dados_munic <- merge(mMapBiomas, Censo2022, by = c("ibge", "Município", "UF"), all = TRUE)

Dados_munic <- merge(Dados_munic, IDHM2010, by = c("Município", "UF"), all = TRUE)

Dados_munic <- merge(Dados_munic, Costeiro, by = c("ibge", "Município"), all = TRUE) %>% 
  mutate(Costeiro = ifelse(is.na(Costeiro), "Interior", "Costeiro"))

Dados_munic <- Dados_munic %>% 
  filter(!is.na(Município),
         !is.na(Ano))%>% 
  mutate(`Decil populacional` = ntile(Populacao_2022, n = 10))


saveRDS(Dados_munic, file = here("Dados/Dados_munic.RDS"))

rm(Censo2022, Costeiro, IDHM2010, mMapBiomas)
```

## 1.4 Juntando as bases de dados:

```{r, 'Juntando_Desastres_Munic'}
Desastres <- readRDS(here("Dados/Desastres.RDS"))
mCidadesAl <- readRDS(file = here("Dados/mCidadesAL.RDS"))
Dados_munic <- readRDS(file = here("Dados/Dados_munic.RDS"))

df <- merge(Desastres, Dados_munic, by = c("ibge", "UF", "Ano"), all.x = T) %>% 
  rename("Município" = Município.x) %>% 
  select(!(Município.y)) %>% 
  mutate(Municipio = gsub("[[:punct:][:space:]]", "", iconv(Município, to = "ASCII//TRANSLIT")),
         Data = as.character(Data))
```

```{r, 'juntando_projetos'}
#Criando banco de dados resumido de atividade legislativa:
dfal <- mCidadesAl %>% 
  group_by(Ano, Data, Município, UF, prim.ano, Tipo_Projeto, clima_termos, projetoclima) %>% 
  summarise(N_AL = n()) %>% 
  rename(Municipio = Município)%>% 
  mutate(Data = as.character(Data))

rm(mCidadesAl) 

#Filtrando municípios que não aparecem na lista de desastres
municipios_df <- unique(df$Municipio) #Cria lista de municípios únicos na lista anterior

dfal <- dfal %>% #Remove valores que não estão na primeira coluna
  filter(Municipio %in% municipios_df)

#Adicionando dados municipais:

# Pega dados dos municípios para repassar para outra coluna
df_dados_munic<- df %>%
  select(Municipio, Município, UF, ibge, regiao, Bioma, Costeiro, `Decil populacional`) %>%
  filter(!is.na(Município)) %>% 
  distinct()
  
#Adiciona os dados municipais em dfal
dfal <- merge(dfal, df_dados_munic, by = c("Municipio", "UF"), all.x = T)

#Filtrando no df os que não estão no dfal
df <- df %>% #Remove valores que não estão na primeira coluna
  filter(ibge %in% dfal$ibge)


#Juntando os dados de desastres e projetos. 
df <- merge(df, dfal, by = c("Ano", "Data", "ibge", "Municipio", "Município", "UF", "regiao", "Bioma", "Costeiro", "Decil populacional"), all = T) %>%
  mutate(Data =  str_replace(as.character(Data), "^[^-]+", as.character(Ano))) %>%
  arrange(Data) %>% 
  mutate(TDesastre = ifelse(is.na(Desastre), FALSE, TRUE),
         Data = as.Date(Data)) %>% 
  select(!(c(Municipio)))

#ADICIONAR ESTAÇÕES DO ANO
saveRDS(df, file = here("Dados/df.RDS"))
rm(df_dados_munic, dfal, municipios_df)
```

# 2. Análise descritiva dos dados:

## 2.1 Desastres

```{r}
df <- readRDS(here("Dados/df.RDS"))
```

```{r, n_biomas}
df_desastres <- df %>% 
  filter(TDesastre == TRUE)  

p_df <- df_desastres %>%  
  group_by(Desastre, Bioma) %>%
  summarise(n = n()) %>% 
  group_by(Bioma) %>% 
  mutate(p_des = n / sum(n))%>% 
  mutate(Desastre = ifelse(p_des < 0.09, "Outros", Desastre))


graf1 <- p_df%>% 
  ggplot(aes( x = Bioma, y = p_des, fill =Desastre)) + 
  geom_bar(stat = "identity", position = "fill")+ 
  theme_linedraw()+
  labs(title = "Gráfico 1 - Distribuição dos tipos de desastre no 'Atlas', por Bioma")+
  scale_fill_brewer(palette = "Dark2")+
   ylab(label = "Percentual")+
  theme(legend.position="bottom",
        legend.title = element_blank())

ggsave(graf1, file = (here("Gráficos/graf1.png")), width = 20, height = 12, units = "cm")

plot(graf1)
```

```{r, 'n_ocorrencias'}

fig1 <- Desastres %>% 
  count(Desastre) %>% 
  data.frame() %>% 
  arrange(desc(n)) %>% 
  rename("Nº de ocorrências" = n) %>% 
  ggplot(aes(x = `Nº de ocorrências`, y = reorder(Desastre, `Nº de ocorrências`))) +
  geom_col() +
  theme_linedraw()+ 
  xlab(label = "Número de ocorrências") +
  ylab(label = "Tipo de desastre") +
  labs(title = "Figura 1- Número de ocorrências no 'Atlas' (1991-2022)")+
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) +
  theme(legend.position="none", text=element_text(size=10))+ 
  scale_fill_brewer(palette = "Dark2")

plot(fig1)
```

```{r, 'Cronologia_Desastres'}
Desastres <- readRDS(here("Dados/Desastres.RDS"))

pDesastres <- Desastres %>%
  group_by(Desastre, Ano) %>% 
  summarise(n_al = n()) %>%
  group_by(Ano) %>%
  mutate(p_al = n_al / sum(n_al))

ggDesastres <- merge(Desastres, pDesastres, by = c('Desastre', 'Ano'), all.x = T) %>% 
  mutate(p_al = ifelse(is.na(p_al), 0, p_al))%>% 
  mutate(Desastre = ifelse(p_al < 0.06, "Outros", Desastre))

fig2 <- ggDesastres%>% 
  group_by(Ano, Desastre) %>% 
  summarise("Ocorrências" = n()) %>% 
  arrange(Ano) %>% 
  ggplot(aes(x = Ano, y = Ocorrências , fill = Desastre)) +
  geom_bar(stat="identity") +
  theme_linedraw()+
  xlab(label = "Ano") +
  ylab(label = "Número de ocorrências") +
  labs(title = "Figura 2 - Número de ocorrências no 'Atlas' (1991-2022)")+
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1),
        legend.position="bottom", text=element_text(size=10))+
  theme(legend.title = element_blank())+
  scale_fill_brewer(palette = "Dark2")
    

plot(fig2)
```

```{r, 'Decis populacionais'}

df_desastres <- readRDS(here("Dados/df.RDS")) %>% 
  filter(TDesastre == TRUE)  

p_df <- df_desastres %>%  
  group_by(Desastre, `Decil populacional`) %>%
  summarise(n = n()) %>% 
  group_by(`Decil populacional`) %>% 
  mutate(p_des = n / sum(n))%>% 
  mutate(Desastre = ifelse(p_des < 0.065, "Outros", Desastre))


fig3 <- p_df%>% 
  ggplot(aes( x = `Decil populacional`, y = p_des, fill =Desastre)) + 
  geom_bar(stat = "identity", position = "fill")+ 
  theme_linedraw()+
  labs(title = "Figura 3 - Distribuição dos tipos de desastre, por decil populacional")+
  scale_fill_brewer(palette = "Dark2")+
   ylab(label = "Percentual")+
  theme(legend.position="bottom",
        legend.title = element_blank())
plot(fig3)
```

## 2.2 Descritivo Atividade Legislativa das Câmaras Municipais

```{r 'N_cidades_ano'}
mCidadesAl <- readRDS(file = here("Dados/mCidadesAL.RDS"))
# Calcula quantas cidades aparecem em cada ano:
presence <- mCidadesAl %>%
  group_by(Ano, Município) %>%
  summarise(N_Proj = n()) %>% 
  ungroup() %>%
  complete(Ano, Município, fill = list(N_Proj = 0)) %>%  
  mutate(presente = ifelse(N_Proj > 0 , 1, 0)) %>% 
  group_by(Ano) %>% 
  summarise(n_cidades = sum(presente)) %>% 
  mutate(percent= n_cidades / max(n_cidades))


# Create the plot
fig4 <- ggplot(presence, aes(x = Ano, y = n_cidades)) +
  geom_bar(stat = "identity", fill = "#1B9E77") +
  labs(x = "Ano", y = "Número de cidades") +
  ggtitle("Figura 4 - Número de cidades presentes na base de dados por ano") +
  theme_linedraw()+
  scale_y_continuous(n.breaks = 10)+
  scale_x_continuous(n.breaks = 10)

plot(fig4)

rm(presence)
```

```{r 'Tipos_Projetos'}
tiproj <- mCidadesAl %>%
  group_by(Tipo_Projeto, Ano) %>% 
  summarise(n_al = n()) %>%
  group_by(Ano) %>%
  mutate(p_al = n_al / sum(n_al))%>% 
  mutate(Tipo_Projeto = ifelse(p_al < 0.06, "Outros", Tipo_Projeto)) %>%
  group_by(Tipo_Projeto, Ano) %>%
  summarise(p_al = sum(p_al))

fig5 <- tiproj %>% 
  ggplot(aes( x = `Ano`, y = p_al, fill = Tipo_Projeto)) + 
  geom_bar(stat = "identity")+ 
  theme_linedraw()+
  labs(title = "Figura 5 - Distribuição dos tipos de projeto, por ano")+
  scale_fill_brewer(palette = "Dark2")+
  ylab('Percentual de projetos')

plot(fig5)
```

# 3. Definindo recorte temporal

```{r, 'Tabela_contagem_AL_tempo'}
#Caso df não esteja carreagado:
df <- readRDS(here("Dados/df.RDS")) 

df2 <- df %>% 
  filter(TDesastre == F)
  
df_contagem <- data.frame(Ano = c(),  n_municipios = c(), AL_Ano = c(), AL_pos_ano = c()) #Tabela para contagem
Anos <- df2 %>% distinct(Ano) #Anos no dataframe df

#Loop para criar tabela comparando número de observações por ano:
for (i in min(Anos):max(Anos)){
  #Cria uma variável com o número de observações no ano i selecionado
  dfano <- df2 %>% 
    filter(Ano == i)
  #Cria uma variável com o código de municípios distintos no ano
  ctm_municipios <- dfano %>% 
    distinct(ibge) 
  #Cria uma variável com todos registros dos municípios presentes no ano "i" nos anos posteriores
  dfanomais <- df2 %>% 
    filter(Ano >= i,
           ibge %in% ctm_municipios$ibge)
  
  #Criando linha do dataframe para o ano
  df_ctm <- data.frame("Ano" = i, "n_municipios" = n_distinct(ctm_municipios), "AL_Ano" = nrow(dfano), "AL_pos_ano" = nrow(dfanomais))
  
  #Juntando à tabela principal
  df_contagem <- bind_rows(df_contagem, df_ctm)  
}

rm(Anos, dfano, ctm_municipios, dfanomais, df_ctm, i, df2)
```

```{r, 'plotando_contagem_tempo'}

# Criar o gráfico
fig6 <- ggplot(df_contagem, aes(x = Ano)) +
  # Adicionar o gráfico de barras para "n_municipios"
  geom_bar(aes(y = n_municipios), stat = "identity", fill = "#1B9E77") +
  # Adicionar o gráfico de linha para "AL_pos_ano"
  geom_line(aes(y = AL_pos_ano * (max(df_contagem$n_municipios) / max(df_contagem$AL_pos_ano)))) +
  geom_vline(xintercept = 2013, linetype = "dashed")+
  # Adicionar eixos duplos
  scale_y_continuous(
    name = "Número de Municípios",
    sec.axis = sec_axis(~ . * (max(df_contagem$AL_pos_ano) / max(df_contagem$n_municipios)), name = "Registros nos anos subsequentes (até 2022)",
      breaks = scales::pretty_breaks(),
      labels = scales::comma_format(big.mark = ".", decimal.mark = ","))
  ) +
  scale_x_continuous(n.breaks = 10)+
  # Personalizar cores e temas
  theme_linedraw()+
  labs(title = "Figura 6 - Nº de municípios na base de dados por ano x Total de registros nos anos subsequentes")+
  theme(title = element_text(size = 9),
        axis.text.y.left = element_text(color = "#1B9E77", size = 10),   # Cor do texto do eixo Y à esquerda
        axis.title.y.left = element_text(color = "#1B9E77"))   # Cor do título do eixo Y à esquerda


# Exibir o gráfico
print(fig6)

```

# 4. Teste de análise Diff-in-Diff

```{r 'Limpando banco de dados'}
#Caso df não esteja carreagado:
df <- readRDS(here("Dados/df.RDS"))

#Escolhi 2013 como ano de corte
df_ibge_2013 <- df %>% 
  filter(TDesastre == F) %>%
  filter(Ano == 2013) %>% 
  select(ibge) %>% 
  distinct()

df2013 <- df %>% 
  filter(ibge %in% df_ibge_2013$ibge,
         !is.na(ibge)) %>% 
  mutate(Data = as.Date(Data))%>% #Adicionar datas posteriores
  mutate("d_4a" = as.Date(ifelse(Data-1461 < min(Data), NA, Data-1461)),
         "d_1a" = as.Date(ifelse(Data-365 < min(Data), NA, Data-365)),
         "d_90" = as.Date(ifelse(Data-90 < min(Data), NA, Data-90)),
         "d_30" = as.Date(ifelse(Data-30 < min(Data), NA, Data-30)),
         "d30" = as.Date(ifelse(Data+30 < min(Data), NA, Data+30)),
         "d90" = as.Date(ifelse(Data+90 < min(Data), NA, Data+90)),
         "d1a" = as.Date(ifelse(Data+365 < min(Data), NA, Data+365)),
         "d4a" = as.Date(ifelse(Data+1461 < min(Data), NA, Data+1461)))


#Dataframe Desastres
df2013_desastres <- df2013 %>% 
  filter(TDesastre == T) 

#Dataframe Atividade Legislativa
df2013_al_reduzido <- df2013 %>% 
  filter(TDesastre == F, 
         projetoclima == T) 

#Dataframe Lista de Municípios
df2013_sum <- df2013 %>% 
  group_by(ibge, Município, UF, TDesastre) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = TDesastre, values_from = n) %>% 
  rename("N_Desastres" = "TRUE",
         "N_Documentos" = "FALSE") %>% 
  mutate(N_Documentos = ifelse(is.na(N_Documentos), 0, N_Documentos),
         N_Desastres = ifelse(is.na(N_Desastres), 0, N_Desastres))

rm(df, df_ibge_2013)
saveRDS(df2013, file = here("Dados/df2013.RDS"))
write_csv(df2013_sum, file =  here("Dados/df2013_sumario.csv"))
```

```{r, 'loop_novas_colunas'}
#Criando as novas colunas como dataframe separado
novas_colunas <- c("t_4a", "c_4a", "t_1a", "c_1a", "t_90", "c_90", "t_30", "c_30", 
                   "t30", "c30", "t90", "c90", "t1a", "c1a", "t4a","c4a")


ncdf <- data.frame(matrix(nrow = 0, ncol = length(novas_colunas)))

colnames(ncdf) <- novas_colunas

for (i in 1: nrow(df2013_desastres)){
  #30 DIAS --------------------------------------------------------------
    #Tratamento
      #Antes
        #Municípios COM desastres no mesmo dia:
  
  t_30 <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data >= df2013_desastres[i, "d_30"],
         Data < df2013_desastres[i, 'Data'],
         ibge == df2013_desastres[i, 'ibge']) %>% 
  nrow()
  
      #Depois
  t30 <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data <= df2013_desastres[i, "d30"],
         Data > df2013_desastres[i, 'Data'],
         ibge == df2013_desastres[i, 'ibge']) %>% 
    nrow()
  
    #Controle
  #PROBLEMA A SER OBSERVADO: POR SER MÉDIA, UNIDADE DE CONTROLE TAMBÉM TEM DISTRIBUIÇÃO E ERRO. -> DEPOIS FAZER COM DISTRIBUIÇÃO DE TODOS OS CONTROLES. 
      #Antes
        #Nº de projetos
  c_30l <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data >= df2013_desastres[i, "d_30"],
         Data < df2013_desastres[i, 'Data'],
         ibge != df2013_desastres[i, 'ibge']) 
  
        #Média
  c_30 <- nrow(c_30l)/n_distinct(df2013_al_reduzido$ibge)
  
      #Depois
        #Nº de projetos
  c30l <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data <= df2013_desastres[i, "d30"],
         Data > df2013_desastres[i, 'Data'],
         ibge != df2013_desastres[i, 'ibge']) 

        #Média
  c30 <- nrow(c30l)/n_distinct(df2013_al_reduzido$ibge)
  

  #90 DIAS --------------------------------------------------------------
    #Tratamento
      #Antes
        #Municípios COM desastres no mesmo dia:
    
  t_90 <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data >= df2013_desastres[i, "d_90"],
         Data < df2013_desastres[i, 'Data'],
         ibge == df2013_desastres[i, 'ibge']) %>% 
  nrow()
      #Depois
  t90 <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data <= df2013_desastres[i, "d90"],
         Data > df2013_desastres[i, 'Data'],
         ibge == df2013_desastres[i, 'ibge']) %>% 
    nrow()
  
    #Controle
  #PROBLEMA A SER OBSERVADO: POR SER MÉDIA, UNIDADE DE CONTROLE TAMBÉM TEM DISTRIBUIÇÃO E ERRO. -> DEPOIS FAZER COM DISTRIBUIÇÃO DE TODOS OS CONTROLES. 
      #Antes
        #Nº de projetos
  c_90l <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data >= df2013_desastres[i, "d_90"],
         Data < df2013_desastres[i, 'Data'],
         ibge != df2013_desastres[i, 'ibge']) 

        #Média
    c_90 <- nrow(c_90l)/n_distinct(df2013_al_reduzido$ibge)
    
      #Depois
        #Nº de projetos
  c90l <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data <= df2013_desastres[i, "d90"],
         Data > df2013_desastres[i, 'Data'],
         ibge != df2013_desastres[i, 'ibge']) 

        #Média
  c90 <- nrow(c90l)/n_distinct(df2013_al_reduzido$ibge)
  
  #365 DIAS (1 ano) --------------------------------------------------------------
    #Tratamento
      #Antes
        #Municípios COM desastres no mesmo dia:
    
  t_1a <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data >= df2013_desastres[i, "d_1a"],
         Data < df2013_desastres[i, 'Data'],
         ibge == df2013_desastres[i, 'ibge']) %>% 
  nrow()
      #Depois
  t1a <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data <= df2013_desastres[i, "d1a"],
         Data > df2013_desastres[i, 'Data'],
         ibge == df2013_desastres[i, 'ibge']) %>% 
    nrow()
  
    #Controle
  #PROBLEMA A SER OBSERVADO: POR SER MÉDIA, UNIDADE DE CONTROLE TAMBÉM TEM DISTRIBUIÇÃO E ERRO. -> DEPOIS FAZER COM DISTRIBUIÇÃO DE TODOS OS CONTROLES. 
      #Antes
        #Nº de projetos
  c_1al <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data >= df2013_desastres[i, "d_1a"],
         Data < df2013_desastres[i, 'Data'],
         ibge != df2013_desastres[i, 'ibge']) 

        #Média
  c_1a <- nrow(c_1al)/n_distinct(df2013_al_reduzido$ibge)
      #Depois
        #Nº de projetos
  c1al <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data <= df2013_desastres[i, "d1a"],
         Data > df2013_desastres[i, 'Data'],
         ibge != df2013_desastres[i, 'ibge']) 

        #Média
  c1a <- nrow(c1al)/n_distinct(df2013_al_reduzido$ibge)
  
  #1461 DIAS (4 anos) --------------------------------------------------------------
    #Tratamento
      #Antes
        #Municípios COM desastres no mesmo dia:
    
  t_4a <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data >= df2013_desastres[i, "d_4a"],
         Data < df2013_desastres[i, 'Data'],
         ibge == df2013_desastres[i, 'ibge']) %>% 
  nrow()
      #Depois
  t4a <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data <= df2013_desastres[i, "d4a"],
         Data > df2013_desastres[i, 'Data'],
         ibge == df2013_desastres[i, 'ibge']) %>% 
    nrow()
  
    #Controle
  #PROBLEMA A SER OBSERVADO: POR SER MÉDIA, UNIDADE DE CONTROLE TAMBÉM TEM DISTRIBUIÇÃO E ERRO. -> DEPOIS FAZER COM DISTRIBUIÇÃO DE TODOS OS CONTROLES. 
      #Antes
        #Nº de projetos
  c_4al <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data >= df2013_desastres[i, "d_4a"],
         Data < df2013_desastres[i, 'Data'],
         ibge != df2013_desastres[i, 'ibge']) 

        #Média
  c_4a <- nrow(c_4al)/n_distinct(df2013_al_reduzido$ibge)
  
      #Depois
        #Nº de projetos
  c4al <- df2013_al_reduzido %>% 
    filter(projetoclima == TRUE,
         Data <= df2013_desastres[i, "d4a"],
         Data > df2013_desastres[i, 'Data'],
         ibge != df2013_desastres[i, 'ibge']) 

        #Média
  c4a <- nrow(c4al)/n_distinct(df2013_al_reduzido$ibge)
  
  # ---------------------------------------------------------------------------
  
  nova_linha <- data.frame(t_4a, c_4a, t_1a, c_1a, t_90, c_90, t_30, c_30, 
                           t30, c30, t90, c90, t1a, c1a, t4a,c4a)
  
  ncdf <- bind_rows(ncdf, nova_linha)
}

df2013_desastres <- bind_cols(df2013_desastres, ncdf)%>% 
  mutate("t_4a" = ifelse(is.na(d_4a) | is.na(d4a), NA, t_4a),
         "t_1a" = ifelse(is.na(d_1a) | is.na(d1a), NA, t_1a),
         "t_90" = ifelse(is.na(d_90) | is.na(d90), NA, t_90),
         "t_30" = ifelse(is.na(d_30) | is.na(d30), NA, t_30),
         "t30" = ifelse(is.na(d30) | is.na(d_30), NA, t30),
         "t90" = ifelse(is.na(d90) | is.na(d_90), NA, t90),
         "t1a" = ifelse(is.na(d1a) | is.na(d_1a), NA, t1a),
         "t4a" = ifelse(is.na(d4a) | is.na(d_4a), NA, t4a),
         "c_4a" = ifelse(is.na(d_4a) | is.na(d4a), NA, c_4a),
         "c_1a" = ifelse(is.na(d_1a) | is.na(d1a), NA, c_1a),
         "c_90" = ifelse(is.na(d_90) | is.na(d90), NA, c_90),
         "c_30" = ifelse(is.na(d_30) | is.na(d30), NA, c_30),
         "c30" = ifelse(is.na(d30) | is.na(d_30), NA, c30),
         "c90" = ifelse(is.na(d90) | is.na(d_90), NA, c90),
         "c1a" = ifelse(is.na(d1a) | is.na(d_1a), NA, c1a),
         "c4a" = ifelse(is.na(d4a) | is.na(d_4a), NA, c4a)) %>% 
  filter(!is.na(t30))

rm(i, t_4a, c_4a, c_4al, t_1a, c_1a, c_1al, t_90, c_90, c_90l, t_30, c_30, c_30l, t30, c30, c30l, t90, c90, c90l, t1a, c1a, c1al, t4a, c4a, c4al, nova_linha, novas_colunas, ncdf)

saveRDS(df2013_desastres, file = here("Dados/df2013_desastres.RDS"))
```

```{r, 'pivot_colunas_dd'}
#df2013_desastres <- readRDS(here("Dados/df2013_desastres.RDS"))

df_dd <- df2013_desastres %>% 
  select(ibge, Data, Ano, Bioma, Costeiro, Populacao_2022, IDHM_2010, t_4a, c_4a, t_1a, c_1a, t_90, c_90, t_30, c_30, t30, c30, t90, c90, t1a, c1a, t4a,c4a)  %>% 
  pivot_longer(
    cols = c(t_4a, c_4a, t_1a, c_1a, t_90, c_90, t_30, c_30, t30, c30, t90, c90, t1a, c1a, t4a,c4a),  # Seleciona as colunas a serem pivotadas
    names_to = "Codigo_tratamento",       # Coluna nova
    values_to = "agenda_clima"                  # Coluna para valores
  ) %>%
  # Cria novas colunas
  mutate(
    Tratamento = ifelse(substr(Codigo_tratamento, 1, 1) == "t", 1, 0),  # Checa se começa com t"
    Tempo = ifelse(grepl("_", Codigo_tratamento), 0, 1), # Checa se contêm "_"
    Periodo = substr(Codigo_tratamento, nchar(Codigo_tratamento) - 1, nchar(Codigo_tratamento))  # Extrai o resto
  ) %>% 
  filter(!is.na(agenda_clima),
         Ano >= 2014, 
         Ano <= 2022) %>% 
  mutate("Ambiente" = paste(Bioma, Costeiro, sep = "_")) %>% 
  select(-(c(Bioma, Costeiro))) 

rm(df2013_desastres)
```

```{r, adicionando_estacao_propensao}

#Adicionando estações
df_dd <- df_dd %>%
  mutate(Estacao = case_when(
    (month(Data) == 12 & day(Data) >= 21)|
      (month(Data) == 1 & day(Data) >= 1) | 
      (month(Data) == 2) | 
      (month(Data) == 3 & day(Data) < 20) ~ "Verão",
    (month(Data) == 3 & day(Data) >= 20) | 
      (month(Data) == 4) |
      (month(Data) == 5) |
      (month(Data) == 6 & day(Data) < 21) ~ "Outono",
    (month(Data) == 6 & day(Data) >= 21) | 
      (month(Data) == 7) |
      (month(Data) == 8) |
      (month(Data) == 9 & day(Data) < 23) ~ "Inverno",
    (month(Data) == 9 & day(Data) >= 23) | 
      (month(Data) == 10) |
      (month(Data) == 11) |
      (month(Data) == 12 & day(Data) < 21) ~ "Primavera",
    TRUE ~ "Desconhecida" ))

#Adicionando propensão
df <- readRDS(here("Dados/df.RDS"))

df_propensao <- df %>% 
  filter(TDesastre == T) %>% 
  group_by(ibge) %>% 
  summarise(propensao = n())

df_dd <- df_dd %>% 
  left_join(df_propensao) %>% 
  filter(Ano >= 2014) #corrigir ano aqui

saveRDS(df_dd, file = here("Dados/df_dd.RDS"))

rm(df, estacao, df2013_sum, df_propensao, df_contagem)
```

## Gráficos da base de dados df_dd

```{r, base_graficos}
df2013grafs <- df2013 %>%
  filter(Ano > 2013,
         Ano <= 2022) %>% 
  mutate(Tipo_Projeto = case_when(
    Tipo_Projeto == "Indicacoes" ~ "Indicacao",
    Tipo_Projeto == "Pedido de providencias" ~ "Pedido de providencia",
    Tipo_Projeto == "Projeto de lei" ~ "Projeto de lei ordinaria",
    .default = as.character(Tipo_Projeto)))



```

```{r, grafico_desastres}

tipdesastre <-df2013grafs %>%
  filter(TDesastre == T) %>% 
  group_by(Desastre, Ano) %>% 
  summarise(n_al = n()) %>% 
  group_by(Ano) %>%
  mutate(p_al = n_al / sum(n_al))%>% 
  mutate(Desastre = ifelse(n_al < 18 | p_al < 0.08, "Outros", Desastre),
         Ano = as.character(Ano))

fig7 <- tipdesastre %>% 
  ggplot(aes( x = `Ano`, y = n_al, fill = Desastre)) + 
  geom_bar(stat = "identity")+ 
  theme_linedraw()+
  labs(title = "Distribuição dos tipos de desastre na seleção do SAPL, por ano")+
  scale_fill_brewer(palette = "Dark2")+
  ylab('Número de desastres registrados')

plot(fig7)
```

```{r, grafico projetos}

tiproj <-df2013grafs %>%
  filter(TDesastre == F, 
         projetoclima == T) %>% 
  group_by(Tipo_Projeto, Ano) %>% 
  summarise(n_al = n()) %>% 
  group_by(Ano) %>%
  mutate(p_al = n_al / sum(n_al))%>% 
  mutate(Tipo_Projeto = ifelse(p_al < 0.025 | n_al < 5, "Outros", Tipo_Projeto),
         Ano = as.character(Ano))

fig8 <- tiproj %>% 
  ggplot(aes( x = `Ano`, y = n_al, fill = Tipo_Projeto)) + 
  geom_bar(stat = "identity")+ 
  theme_linedraw()+
  labs(title = "Distribuição dos tipos de documentos na seleção do SAPL, por ano")+
  scale_fill_brewer(palette = "Dark2")+
  ylab('Número de documentos')

plot(fig8)
```

```{r}

tipdesastre_bioma <-df2013grafs %>%
  filter(TDesastre == T) %>% 
  mutate(Bioma_Costeiro = paste(Bioma, Costeiro, sep = "_")) %>% 
  group_by(Desastre, Bioma_Costeiro, Ano) %>% 
  summarise(n_al = n()) %>% 
  group_by(Ano) %>%
  mutate(p_al = n_al / sum(n_al))

fig11 <- tipdesastre_bioma %>% 
  ggplot(aes( x = `Ano`, y = n_al, fill = Desastre)) + 
  geom_bar(stat = "identity")+ 
  theme_linedraw()+
  labs(title = "Distribuição dos tipos de desastre na seleção do SAPL, por ano")+
  ylab('Número de desastres registrados')+
  scale_x_continuous(breaks = c(2014, 2018, 2022))+
  facet_wrap(.~ Bioma_Costeiro)

plot(fig11)
```

```{r}
tipdesastre_estacao <-df2013grafs %>% 
  filter(TDesastre == T) %>% 
  mutate(Estacao = case_when(
    (month(Data) == 12 & day(Data) >= 21)|
      (month(Data) == 1 & day(Data) >= 1) | 
      (month(Data) == 2) | 
      (month(Data) == 3 & day(Data) < 20) ~ "Verão",
    (month(Data) == 3 & day(Data) >= 20) | 
      (month(Data) == 4) |
      (month(Data) == 5) |
      (month(Data) == 6 & day(Data) < 21) ~ "Outono",
    (month(Data) == 6 & day(Data) >= 21) | 
      (month(Data) == 7) |
      (month(Data) == 8) |
      (month(Data) == 9 & day(Data) < 23) ~ "Inverno",
    (month(Data) == 9 & day(Data) >= 23) | 
      (month(Data) == 10) |
      (month(Data) == 11) |
      (month(Data) == 12 & day(Data) < 21) ~ "Primavera",
    TRUE ~ "Desconhecida" )) %>% 
  group_by(Desastre, Estacao, Ano) %>% 
  summarise(n_al = n()) %>% 
  group_by(Ano) %>%
  mutate(p_al = n_al / sum(n_al))

fig12 <- tipdesastre_estacao %>% 
  ggplot(aes( x = `Ano`, y = n_al, fill = Desastre)) + 
  geom_bar(stat = "identity")+ 
  theme_linedraw()+
  labs(title = "Distribuição dos tipos de desastre na seleção do SAPL, por ano e estação")+
  ylab('Número de desastres registrados')+
  scale_x_continuous(breaks = c(2014, 2018, 2022))+
  facet_wrap(.~ Estacao)

plot(fig12)
```

## Fazendo a regressão Diff-in-Diff

### 30 dias

```{r, 'reg30'}

df_dd<- readRDS(here("Dados/df_dd.RDS"))

#30 dias
df_dd30 <- df_dd %>% 
  filter(Periodo == 30) 

#Fazendo a regressão:
  #Colocar multiplicação (*) entre dummy de tratamento e tempo para diff-in-diff:
reg30 <- lm(agenda_clima ~ Tratamento*Tempo + Tratamento + Tempo + Ambiente + Estacao + Populacao_2022 + IDHM_2010 + propensao, data = df_dd30)

#+ Ambiente + Populacao_2022 + IDHM + Propensão + Estacao
stargazer(reg30,title="Período de 30 dias", single.row=TRUE, ci=TRUE, ci.level=0.5)
```

```{r, 'ggplot_reg30'}
#Visualizando o efeito: 

vreg30 <- broom::tidy(reg30) %>% 
  filter(term %in% c("(Intercept)", "Tratamento", "Tempo", "Tratamento:Tempo")) %>% 
  mutate(Valor = case_when(
    term == "(Intercept)" ~ estimate,
    term == "Tempo" ~ estimate + reg30$coefficients[1],
    term == "Tratamento" ~ estimate + reg30$coefficients[1],
    term == "Tratamento:Tempo" ~ estimate + reg30$coefficients[1] + reg30$coefficients["Tempo"] + reg30$coefficients["Tratamento"] + reg30$coefficients["Tratamento:Tempo"]),
         Tratamento = case_when(
           term == "(Intercept)" ~ "Controle",
           term == "Tempo" ~ "Controle",
           term == "Tratamento" ~ "Tratamento",
           term == "Tratamento:Tempo" ~ "Tratamento"),
         Tempo = case_when(
           term == "(Intercept)" ~ -1,
           term == "Tempo" ~ 1,
           term == "Tratamento" ~ -1,
           term == "Tratamento:Tempo" ~ 1)) 


ggreg30 <- vreg30 %>% 
  ggplot(aes(x = Tempo, y=Valor, color = Tratamento, group = Tratamento))+
  geom_point(size = 1)+
  geom_errorbar(aes(ymin = Valor - 1.96 * std.error, ymax = Valor + 1.96 * std.error, width = 0.3)) +
  geom_line()+
  geom_vline(xintercept = 0, linetype = "dashed")+
  theme_linedraw()+
  labs(title = "Figura 7 - Diff-in-Diffs: 30 dias",
        x = "Tempo em relação ao tratamento",
        y = "Nº médio de projetos climáticos")+
  scale_color_brewer(palette = "Dark2")+
  scale_x_continuous(breaks = c(-1, 0, 1),  # Set custom breaks for x-axis
                     labels = c("-30 dias", "Tratamento", "+30 dias"))+
  ylim(0,max(vreg30$Valor)+2*max(vreg30$std.error))

ggreg30
```

```{r 'Checagem)lm_reg30'}
#Checando os pressupostos
check_reg30 <- check_model(reg30)
```

### 90 dias

```{r, 'reg90'}

#90 dias
df_dd90 <- df_dd %>% 
  filter(Periodo == 90) 

#Fazendo a regressão:
  #Colocar multiplicação (*) entre dummy de tratamento e tempo para diff-in-diff:
reg90 <- lm(agenda_clima ~ Tratamento*Tempo + Tratamento + Tempo + Ambiente + Estacao + Populacao_2022 + IDHM_2010 + propensao, data = df_dd90)

#+ Ambiente + Populacao_2022 + IDHM + Propensão + Estacao
stargazer(reg90,title="Período de 90 dias", single.row=TRUE, ci=TRUE, ci.level=0.5)
```

```{r, 'ggplot_reg90'}
#Visualizando o efeito: 

vreg90 <- broom::tidy(reg90) %>% 
  filter(term %in% c("(Intercept)", "Tratamento", "Tempo", "Tratamento:Tempo")) %>% 
  mutate(Valor = case_when(
    term == "(Intercept)" ~ estimate,
    term == "Tempo" ~ estimate + reg30$coefficients[1],
    term == "Tratamento" ~ estimate + reg30$coefficients[1],
    term == "Tratamento:Tempo" ~ estimate + reg30$coefficients[1] + reg30$coefficients["Tempo"] + reg30$coefficients["Tratamento"] + reg30$coefficients["Tratamento:Tempo"]),
         Tratamento = case_when(
           term == "(Intercept)" ~ "Controle",
           term == "Tempo" ~ "Controle",
           term == "Tratamento" ~ "Tratamento",
           term == "Tratamento:Tempo" ~ "Tratamento"),
         Tempo = case_when(
           term == "(Intercept)" ~ -1,
           term == "Tempo" ~ 1,
           term == "Tratamento" ~ -1,
           term == "Tratamento:Tempo" ~ 1)) 


ggreg90 <- vreg90 %>% 
  ggplot(aes(x = Tempo, y=Valor, color = Tratamento, group = Tratamento))+
  geom_point(size = 1)+
  geom_errorbar(aes(ymin = Valor - 1.96 * std.error, ymax = Valor + 1.96 * std.error, width = 0.3)) +
  geom_line()+
  geom_vline(xintercept = 0, linetype = "dashed")+
  theme_linedraw()+
  labs(title = "Figura 8 - Diff-in-Diffs: 90 dias",
        x = "Tempo em relação ao tratamento",
        y = "Nº médio de projetos climáticos")+
  scale_color_brewer(palette = "Dark2")+
  scale_x_continuous(breaks = c(-1, 0, 1),  # Set custom breaks for x-axis
                     labels = c("-90 dias", "Tratamento", "+90 dias"))+
  ylim(0,max(vreg90$Valor)+2*max(vreg90$std.error))

ggreg90
```

```{r 'Checagem)lm_reg90'}
#Checando os pressupostos
check_reg90 <- check_model(reg90)
```

### 1 ano

```{r, 'reg_1a'}
#1 ano / 365 dias
df_dd1a <- df_dd %>% 
  filter(Periodo == "1a") 

#Fazendo a regressão:
  #Colocar multiplicação (*) entre dummy de tratamento e tempo para diff-in-diff:
reg1a <- lm(agenda_clima ~ Tratamento*Tempo + Tratamento + Tempo + Ambiente + Estacao + Populacao_2022 + IDHM_2010 + propensao, data = df_dd1a)
#+ Ambiente + Populacao_2022 + IDHM + Estacao + Propensao
stargazer(reg1a,title="Período de 1 ano", single.row=TRUE, ci=TRUE, ci.level=0.5)
```

```{r, 'ggplot_reg1a'}
#Visualizando o efeito: 

vreg1a <- broom::tidy(reg1a) %>% 
  filter(term %in% c("(Intercept)", "Tratamento", "Tempo", "Tratamento:Tempo")) %>% 
  mutate(Valor = case_when(
    term == "(Intercept)" ~ estimate,
    term == "Tempo" ~ estimate + reg30$coefficients[1],
    term == "Tratamento" ~ estimate + reg30$coefficients[1],
    term == "Tratamento:Tempo" ~ estimate + reg30$coefficients[1] + reg30$coefficients["Tempo"] + reg30$coefficients["Tratamento"] + reg30$coefficients["Tratamento:Tempo"]),
         Tratamento = case_when(
           term == "(Intercept)" ~ "Controle",
           term == "Tempo" ~ "Controle",
           term == "Tratamento" ~ "Tratamento",
           term == "Tratamento:Tempo" ~ "Tratamento"),
         Tempo = case_when(
           term == "(Intercept)" ~ -1,
           term == "Tempo" ~ 1,
           term == "Tratamento" ~ -1,
           term == "Tratamento:Tempo" ~ 1)) 


ggreg1a <- vreg1a %>% 
  ggplot(aes(x = Tempo, y=Valor, color = Tratamento, group = Tratamento))+
  geom_point(size = 1)+
  geom_errorbar(aes(ymin = Valor - 1.96 * std.error, ymax = Valor + 1.96 * std.error, width = 0.3)) +
  geom_line()+
  geom_vline(xintercept = 0, linetype = "dashed")+
  theme_linedraw()+
  labs(title = "Figura 8 - Diff-in-Diffs: 1 ano",
        x = "Tempo em relação ao tratamento",
        y = "Nº médio de projetos climáticos")+
  scale_color_brewer(palette = "Dark2")+
  scale_x_continuous(breaks = c(-1, 0, 1),  # Set custom breaks for x-axis
                     labels = c("-1 ano", "Tratamento", "+1 ano"))+
  ylim(-2,max(vreg1a$Valor)+2*max(vreg1a$std.error))

ggreg1a
```

```{r 'Checagem_lm_reg1a'}
#Checando os pressupostos
check_reg1a <- check_model(reg1a)
```

### 4 anos

```{r}
#4 anos/ 1461 dias
df_dd4a <- df_dd %>% 
  filter(Periodo == "4a") 


#Fazendo a regressão:
  #Colocar multiplicação (*) entre dummy de tratamento e tempo para diff-in-diff:
reg4a <- lm(agenda_clima ~ Tratamento*Tempo + Tratamento + Tempo + Ambiente + Estacao + Populacao_2022 + IDHM_2010 + propensao, data = df_dd4a)
#+ Ambiente + Populacao_2022 + IDHM + Estacao + Propensao
stargazer(reg4a,title="Período de 4 anos", single.row=TRUE, ci=TRUE, ci.level=0.5)
```

```{r, 'ggplot_reg4a'}
#Visualizando o efeito: 

vreg4a <- broom::tidy(reg4a) %>% 
  filter(term %in% c("(Intercept)", "Tratamento", "Tempo", "Tratamento:Tempo")) %>% 
  mutate(Valor = case_when(
    term == "(Intercept)" ~ estimate,
    term == "Tempo" ~ estimate + reg30$coefficients[1],
    term == "Tratamento" ~ estimate + reg30$coefficients[1],
    term == "Tratamento:Tempo" ~ estimate + reg30$coefficients[1] + reg30$coefficients["Tempo"] + reg30$coefficients["Tratamento"] + reg30$coefficients["Tratamento:Tempo"]),
         Tratamento = case_when(
           term == "(Intercept)" ~ "Controle",
           term == "Tempo" ~ "Controle",
           term == "Tratamento" ~ "Tratamento",
           term == "Tratamento:Tempo" ~ "Tratamento"),
         Tempo = case_when(
           term == "(Intercept)" ~ -1,
           term == "Tempo" ~ 1,
           term == "Tratamento" ~ -1,
           term == "Tratamento:Tempo" ~ 1)) 


ggreg4a <- vreg4a %>% 
  ggplot(aes(x = Tempo, y=Valor, color = Tratamento, group = Tratamento))+
  geom_point(size = 1)+
  geom_errorbar(aes(ymin = Valor - 1.96 * std.error, ymax = Valor + 1.96 * std.error, width = 0.3)) +
  geom_line()+
  geom_vline(xintercept = 0, linetype = "dashed")+
  theme_linedraw()+
  labs(title = "Figura 8 - Diff-in-Diffs: 4 anos",
        x = "Tempo em relação ao tratamento",
        y = "Nº médio de projetos climáticos")+
  scale_color_brewer(palette = "Dark2")+
  scale_x_continuous(breaks = c(-1, 0, 1),  # Set custom breaks for x-axis
                     labels = c("-4 anos", "Tratamento", "+4 anos"))+
  ylim(-4,max(vreg4a$Valor)+2*max(vreg4a$std.error))

ggreg4a
```

```{r 'Checagem_lm_reg4a'}
#Checando os pressupostos
check_reg4a <- check_model(reg4a)
```

```{r, juntando_vregdfs}
# Adiciona coluna com nomes
vreg30 <- mutate(vreg30, Período = "30 dias")
vreg90 <- mutate(vreg90, Período = "90 dias")
vreg1a <- mutate(vreg1a, Período = "1 ano")
vreg4a <- mutate(vreg4a, Período = "4 anos")

# Combine the dataframes using bind_rows
vregdfs <- bind_rows(vreg30, vreg90, vreg1a, vreg4a)


```

```{r, factegrid_efeitos}

vregdfs$Período <- factor(vregdfs$Período, levels = c("30 dias", "90 dias", "1 ano", "4 anos"))

#Criando Facet Grid
ggregdfs <- vregdfs %>% 
  ggplot(aes(x = Tempo, y = Valor, color = Tratamento, group = Tratamento))+
  geom_point(size = 1)+
  geom_errorbar(aes(ymin = Valor - 1.96 * std.error, ymax = Valor + 1.96 * std.error, width = 0.3)) +
  geom_line()+
  geom_vline(xintercept = 0, linetype = "dashed")+
  geom_hline(yintercept = 0)+
  theme_linedraw()+
  labs(title = "Diff-in-Diffs",
       x = "Tempo em relação ao tratamento",
       y = "Nº médio de projetos climáticos")+
  scale_color_brewer(palette = "Dark2")+
  scale_x_continuous(breaks = c(-1, 0, 1),  # Set custom breaks for x-axis
                      labels = c("Antes", "Tratamento", "Depois"))+
  ylim(min(vregdfs$Valor)-2*max(vregdfs$std.error), max(vregdfs$Valor)+max(vregdfs$std.error))+
  facet_grid(.~ Período, scales = "free_x", switch = "x") +  #
  theme(legend.position = "bottom")  

ggregdfs

```

```{r, teste de hipóteses}
broom::tidy(reg4a) %>% 
  filter(term %in% c("(Intercept)", "Tratamento", "Tempo", "Tratamento:Tempo")) %>% 
  mutate(Valor = case_when(
    term == "(Intercept)" ~ estimate,
    term == "Tempo" ~ estimate + reg30$coefficients[1],
    term == "Tratamento" ~ estimate + reg30$coefficients[1],
    term == "Tratamento:Tempo" ~ estimate + reg30$coefficients[1] + reg30$coefficients["Tempo"] + reg30$coefficients["Tratamento"] + reg30$coefficients["Tratamento:Tempo"]),
         Tratamento = case_when(
           term == "(Intercept)" ~ "Controle",
           term == "Tempo" ~ "Controle",
           term == "Tratamento" ~ "Tratamento",
           term == "Tratamento:Tempo" ~ "Tratamento"),
         Tempo = case_when(
           term == "(Intercept)" ~ -1,
           term == "Tempo" ~ 1,
           term == "Tratamento" ~ -1,
           term == "Tratamento:Tempo" ~ 1)) 

fig10 <-  ggplot(vregdfs, aes(x = term, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - 1.96 * std.error, ymax = estimate + 1.96 * std.error), width = 0.2) +
  geom_hline(yintercept = 0)+
  labs(title = "Coeficientes do Modelo de Regressão",
       x = "Preditor",
       y = "Estimativa do Coeficiente") +
  theme_linedraw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_grid(.~ Período)

fig10
```

### Visualizando linha do tempo

```{r}
#Visualizando o efeito: 

vregT <- df_dd %>% 
  group_by(Tratamento, Tempo, Periodo) %>% 
  summarise("média_n_projetos" = mean(agenda_clima)) %>% 
  mutate("Tempo" = ifelse(Tempo == 0, -1, 1),
         "Tratamento" = ifelse(Tratamento == 0, "Controle", "Tratado"),
         "Periodo" = case_match(Periodo,
                                "30 dias" ~ 30, 
                                "90 dias" ~ 90,
                                "1 ano" ~ 365,
                                "4 anos" ~ 1461)) %>% 
  mutate("Tempo_P" = Tempo*Periodo,
         "média_n_projetos" = ifelse(Periodo != 1, média_n_projetos*(30/Periodo), média_n_projetos))

ggregT <- vregT %>% 
  ggplot(aes(x = Tempo_P, y=média_n_projetos, color = Tratamento, group = Tratamento))+
  geom_point(size = 5)+
  geom_line()+
  geom_vline(xintercept = 0, linetype = "dashed")+
  labs(title = "Figura 11 - Linha do tempo pré e pós-tratamento",
        x = "Tempo em relação ao tratamento",
        y = "Nº médio de projetos climáticos a cada 30 dias")+
  scale_color_brewer(palette = "Dark2")+
  scale_x_continuous(breaks = c(-1461, -365,-90, -30, 0, 30, 90, 365, 1461),
                     labels = c("-4 anos", "-1 ano", "-90 dias", "-30 dias", "Tratamento", "+30 dias", "+90 dias", "+1 ano", "+4 anos"))+
  theme_linedraw()+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggregT
```

## 5. Mapa dos municípios da amostra:

```{r}
#Listando os municípios que passam pelo tratamento (desastres):

nome_munic <- readRDS(here('Dados/df_dd.RDS')) %>%
  distinct(ibge)

mapa_brasil <- read_municipality(year = 2022)

mapa_munic <- read_municipality(code_muni=nome_munic$ibge[1], year=2022)%>% 
    select(code_muni, geom)


for (i in 2:length(nome_munic$ibge)){
    j <- nome_munic$ibge[i]
  munic_mapa <- read_municipality(code_muni=j, year=2022)%>% 
    select(code_muni, geom)
  
  mapa_munic <- bind_rows(mapa_munic, munic_mapa)
  
}

str(mapa_munic)
summary(mapa_munic)
```

```{r, mapa_ndesastres}
ggplot() +
  geom_sf(data=dataset_final, aes(fill=IDHM), color= NA, size=.15)+
  labs(title="IDHM 2013 (ano base 2010) dos Municipíos de MS",
       caption='Fonte: Elaboração própria', size=8)+
  scale_fill_distiller(palette = "Greens", limits=c(0.5, 0.8),
                       name="Code_muni")+
  theme_minimal()
```

```{r}
mapa_sapl <- ggplot() +
  geom_sf(data=mapa_brasil, alpha = 0.5, fill= "#666666", color = NA, size= .15)+
  geom_sf(data=mapa_munic, fill= "#D95F02", size=.15)+
  labs(title="Mapa dos Municípios do SAPL selecionados",
       caption='Fonte: Elaboração própria', size=8)+
  theme_linedraw()

mapa_sapl
```
